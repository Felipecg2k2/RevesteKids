<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Gerenciamento de Pe√ßas (Minhas Roupas)</title>

    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/roupas.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
</head>

<body>

    <div class="app-layout">

        <%- include('partials/_sidebar', { path: typeof path !=='undefined' ? path : '' }) %>

            <div class="content-area">
                <div class="content-area-pad">

                    <div class="header-actions">
                        <h1>Gerenciamento de Pe√ßas</h1>
                        <% if (!mostrarHistorico) { %>
                            <button id="btn-abrir-modal" class="btn-primary" style="
                                background-color: #9370DB; 
                                color: white; 
                                padding: 10px 20px; 
                                border: none; 
                                border-radius: 4px; 
                                cursor: pointer; 
                                font-size: 16px;
                                font-weight: bold;
                                white-space: nowrap; 
                                transition: background-color 0.2s;
                            " onmouseover="this.style.backgroundColor='#7B68EE'"
                                onmouseout="this.style.backgroundColor='#9370DB'">
                                Adicionar Roupa
                            </button>
                        <% } %>
                    </div>

                    <% 
                    const statusAtual = typeof filtroStatus !== 'undefined' ? filtroStatus : 'Ativo';
                    const isHistorico = mostrarHistorico; 
                    %>

                        <div class="filtros-status">
                            <a href="/roupas?status=Ativo" class="filtro-item-link">
                                <div class="filtro-item <%= (statusAtual === 'Ativo' && !isHistorico) ? 'ativo' : '' %>"
                                    style="background-color: #e0f7fa;" id="filtro-ativas" data-filtro="Ativo">
                                    <strong>
                                        <%= typeof totalAtivas !== 'undefined' ? totalAtivas : 0 %>
                                    </strong>
                                    <p>Roupas Dispon√≠veis</p>
                                </div>
                            </a>

                            <a href="/roupas?status=EmTroca" class="filtro-item-link">
                                <div class="filtro-item <%= (statusAtual === 'EmTroca' && !isHistorico) ? 'ativo' : '' %>"
                                    style="background-color: #fffde7;" id="filtro-emtroca" data-filtro="EmTroca">
                                    <strong>
                                        <%= typeof emTroca !== 'undefined' ? emTroca : 0 %>
                                    </strong>
                                    <p>Roupas em Negocia√ß√£o</p>
                                </div>
                            </a>

                            <a href="/roupas?status=Historico" class="filtro-item-link">
                                <div class="filtro-item <%= isHistorico ? 'ativo' : '' %>"
                                    style="background-color: #e8f5e9;" id="filtro-historico-link"
                                    data-filtro="Historico">
                                    <strong>
                                        <%= typeof trocasRealizadas !== 'undefined' ? trocasRealizadas : 0 %>
                                    </strong>
                                    <p>Trocas Finalizadas</p>
                                </div>
                            </a>
                        </div>

                        <% if (isHistorico) { %>
                            <h2>Hist√≥rico de Trocas Conclu√≠das</h2>

                            <div class="historico-grid">

                                <% 
                                // Fun√ß√£o auxiliar para formatar data
                                const formatarData = (dataStr) => {
                                    if (!dataStr) return 'N/A';
                                    try {
                                        return new Date(dataStr).toLocaleDateString('pt-BR', { 
                                            day: '2-digit', 
                                            month: '2-digit', 
                                            year: 'numeric' 
                                        });
                                    } catch (e) {
                                        return 'Data Inv√°lida';
                                    }
                                };
                                %>

                                <% if (historicoTrocas && historicoTrocas.length > 0) { %>

                                    <% historicoTrocas.forEach(function(troca) { %>
                                        <div class="troca-card">

                                            <% 
                                            const idUsuarioLogado = typeof userId !== 'undefined' ? userId : null;
                                            const isProponente = troca.ProponenteId === idUsuarioLogado;
                                            const pecaRecebida = isProponente ? troca.itemDesejado : troca.itemOferecido;
                                            const pecaEnviada = isProponente ? troca.itemOferecido : troca.itemDesejado;
                                            const nomeParceiro = pecaRecebida.usuario ? pecaRecebida.usuario.nome : 'Usu√°rio Desconhecido';
                                            %>

                                                <h3>Troca #<%= troca.id %> - <%= troca.status %></h3>

                                                <div class="item-troca-container">

                                                    <div class="item-troca-info enviada">
                                                        <small>Voc√™ enviou:</small>
                                                        <p>
                                                            <%= pecaEnviada.peca %> (<%= pecaEnviada.tamanho %>)
                                                        </p>
                                                    </div>

                                                    <span class="simbolo-troca">‚ÜîÔ∏è</span>

                                                    <div class="item-troca-info recebida">
                                                        <small>Voc√™ recebeu:</small>
                                                        <p>
                                                            <%= pecaRecebida.peca %> (<%= pecaRecebida.tamanho %>)
                                                        </p>
                                                    </div>
                                                </div>

                                                <p style="font-size: 0.9em; margin-top: 10px;">
                                                    <strong>Trocada com:</strong>
                                                    <%= nomeParceiro %>
                                                </p>

                                                <% if (troca.dataFinalizacao) { %>
                                                    <p style="font-size: 0.85em; color: #555;">
                                                        Finalizada em: <%= formatarData(troca.dataFinalizacao) %>
                                                    </p>
                                                <% } %>

                                                <!-- BOT√ÉO VER DETALHES - ADICIONADO -->
                                                <button class="btn-ver-detalhes" 
                                                        data-troca-id="<%= troca.id %>"
                                                        style="
                                                            background-color: #6a1b9a; 
                                                            color: white; 
                                                            padding: 8px 16px; 
                                                            border: none; 
                                                            border-radius: 4px; 
                                                            cursor: pointer;
                                                            font-weight: bold;
                                                            margin-top: 10px;
                                                            transition: background-color 0.2s;
                                                        "
                                                        onmouseover="this.style.backgroundColor='#4a148c'"
                                                        onmouseout="this.style.backgroundColor='#6a1b9a'">
                                                    <i class="fas fa-eye"></i> Ver Detalhes
                                                </button>
                                        </div>
                                    <% }); %>

                                <% } else { %>
                                    <div class="empty-message">
                                        <h2>Hist√≥rico Vazio</h2>
                                        <p>Voc√™ ainda n√£o possui trocas conclu√≠das em seu hist√≥rico.</p>
                                        <p>Que tal come√ßar uma nova troca no <a href="/feed">feed</a>?</p>
                                    </div>
                                <% } %>
                            </div>

                        <% } else { %>
                            <h2>Pe√ßas em Status: <%= statusAtual === 'Ativo' ? 'Dispon√≠vel' : 'Em Negocia√ß√£o' %></h2>

                            <div class="itens-grid">

                                <% if (itens && itens.length > 0) { %>
                                    <% itens.forEach(function(item) { %>

                                        <div class="item-card">
                                            <div class="image-placeholder">
                                                <% 
                                                let caminhoDaImagem = '/images/placeholder.png';
                                                
                                                // 1. Geramos a lista completa de objetos de imagem
                                                const listaImagensObj = (item.imagens || []).map(img => {
                                                    const nomeDoArquivo = img.caminho_arquivo;
                                                    const caminhoCompleto = nomeDoArquivo.startsWith('/') || nomeDoArquivo.startsWith('http')
                                                        ? nomeDoArquivo 
                                                        : '/uploads/' + nomeDoArquivo;
                                                    
                                                    return {
                                                        id: img.id, 
                                                        caminho_arquivo: nomeDoArquivo,
                                                        caminho_url: caminhoCompleto,
                                                        is_principal: img.is_principal
                                                    };
                                                });
                                                
                                                // 2. A imagem principal para a capa do card
                                                const imagemPrincipal = listaImagensObj.length > 0 ? listaImagensObj[0].caminho_url : caminhoDaImagem;
                                                %>
                                                
                                                <img src="<%= imagemPrincipal %>" alt="<%= item.peca %>"
                                                    style="width: 100%; height: auto; object-fit: cover;">
                                            </div>

                                            <h3>
                                                <%= item.peca %>
                                            </h3>
                                            <p>Tamanho: <%= item.tamanho %></p>
                                            <p style="font-size: 0.9em; color: #666; margin-top: -10px;">
                                                <%= item.categoriaPeca %>
                                            </p>
                                            <p
                                                class="status <%= item.statusPosse === 'Ativo' ? 'status-ativo' : 'status-troca' %>">
                                                <%= item.statusPosse === 'Ativo' ? 'Dispon√≠vel' : 'Em Processo de Troca' %>
                                            </p>

                                            <div
                                                style="display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                                                
                                                <% if (listaImagensObj.length > 1) { %>
                                                <button class="btn-ver-fotos" 
                                                    data-peca-nome="<%= item.peca %>"
                                                    data-imagens='<%= JSON.stringify(listaImagensObj.map(img => img.caminho_url)) %>'
                                                    style="
                                                        background-color: #5bc0de; 
                                                        color: white; 
                                                        padding: 8px 12px; 
                                                        border: none; 
                                                        border-radius: 4px; 
                                                        cursor: pointer;
                                                        font-weight: bold;
                                                        transition: background-color 0.2s;
                                                        white-space: nowrap;
                                                    " 
                                                    onmouseover="this.style.backgroundColor='#31b0d5'"
                                                    onmouseout="this.style.backgroundColor='#5bc0de'">
                                                    Ver <%= listaImagensObj.length %> Fotos
                                                </button>
                                                <% } %>
                                                
                                                <% if (item.statusPosse === 'Ativo') { %>
                                                    <a href="#" class="btn-editar" data-item-id="<%= item.id %>"
                                                        data-item='<%= JSON.stringify(item) %>' 
                                                        data-imagens-json='<%= JSON.stringify(listaImagensObj) %>'
                                                        title="Editar"
                                                        style="text-decoration: none; font-size: 1.1em; white-space: nowrap;">
                                                        <i class="fas fa-edit"></i> Editar
                                                    </a>
                                                    <a href="/roupas/excluir/<%= item.id %>"
                                                        onclick="return confirm('Tem certeza que deseja excluir <%= item.peca %>?');"
                                                        title="Excluir"
                                                        style="color: red; text-decoration: none; font-size: 1.1em; white-space: nowrap;">
                                                        <i class="fas fa-trash-alt"></i> Excluir
                                                    </a>
                                                <% } else if (item.statusPosse === 'EmTroca') { %>
                                                    <a href="/trocas" class="btn-ver-troca" 
                                                       style="
                                                           background-color: #ff9800; 
                                                           color: white; 
                                                           padding: 8px 12px; 
                                                           border: none; 
                                                           border-radius: 4px; 
                                                           cursor: pointer;
                                                           text-decoration: none;
                                                           font-weight: bold;
                                                           display: inline-block;
                                                           white-space: nowrap;
                                                           transition: background-color 0.2s;
                                                       " 
                                                       onmouseover="this.style.backgroundColor='#f57c00'"
                                                       onmouseout="this.style.backgroundColor='#ff9800'">
                                                        <i class="fas fa-exchange-alt"></i> Ver Troca
                                                    </a>
                                                <% } else { %>
                                                    <span style="color: #666; font-size: 0.9em;">A√ß√µes Bloqueadas</span>
                                                <% } %>
                                            </div>
                                        </div>
                                    <% }); %>

                                <% } else { %>
                                    <% if (statusAtual === 'EmTroca') { %>
                                        <div class="empty-message"
                                            style="text-align: center; grid-column: 1 / -1;">
                                            <h2>Nenhuma Pe√ßa em Negocia√ß√£o üôÅ</h2>
                                            <p>Voc√™ n√£o possui nenhuma pe√ßa atualmente em processo de troca.</p>
                                            <p>Clique <a href="/roupas?status=Ativo">aqui</a> para ver suas pe√ßas dispon√≠veis.</p>
                                        </div>
                                    <% } else { %>
                                        <div class="empty-message"
                                            style="text-align: center; grid-column: 1 / -1;">
                                            <h2>Nenhuma Pe√ßa Dispon√≠vel para Troca</h2>

                                            <% if (emTroca > 0) { %>
                                                <p>Voc√™ possui <%= emTroca %> pe√ßa(s) em <a
                                                        href="/roupas?status=EmTroca">negocia√ß√£o</a>.</p>
                                            <% } else { %>
                                                <p>Voc√™ ainda n√£o cadastrou nenhuma pe√ßa dispon√≠vel para troca.</p>
                                            <% } %>

                                            <p>Clique no bot√£o Adicionar Roupa para come√ßar a trocar!</p>
                                        </div>
                                    <% } %>
                                <% } %>
                            </div>

                        <% } %>

                        <p style="clear: both; margin-top: 30px;"><a href="/feed">Voltar para o feed</a></p>

                </div>
            </div>
    </div>

    <!-- MODAL DE CADASTRO/EDI√á√ÉO -->
    <div id="modal-cadastro">
        <div class="modal-content">
            <span id="btn-fechar-modal" class="close">&times;</span>
            <h1 id="modal-titulo">Cadastrar Nova Pe√ßa para Troca</h1>

            <form id="form-roupa" method="POST" action="/roupas/salvar" enctype="multipart/form-data">

                <input type="hidden" id="item-id" name="id" value="">
                
                <!-- SE√á√ÉO DE GERENCIAMENTO DE FOTOS EXISTENTES -->
                <div id="fotos-existentes-container" style="display: none; margin-bottom: 20px;">
                    <p style="font-size: 0.9em; font-weight: bold; margin-bottom: 10px; color: #555;">
                        üì∏ Gerenciar Fotos (Arraste para reordenar - a primeira ser√° a capa)
                    </p>
                    
                    <div id="galeria-edicao" class="galeria-ordenavel">
                        <!-- As imagens ser√£o inseridas aqui via JavaScript -->
                    </div>

                    <input type="hidden" id="fotos-reordenadas-json" name="fotos_reordenadas_json" value="[]">
                    <input type="hidden" id="fotos-removidas-json" name="fotos_removidas_json" value="[]">
                </div>
                
                <!-- SE√á√ÉO DE UPLOAD DE NOVAS FOTOS -->
                <div class="upload-area" id="upload-area">
                    <label for="imagens_upload" style="cursor: pointer; display: block;">
                        <i class="fas fa-cloud-upload-alt" style="font-size: 2em; color: #9370DB; margin-bottom: 10px;"></i>
                        <p style="margin: 10px 0; font-weight: bold;">Adicionar Novas Fotos</p>
                        <p style="font-size: 0.85em; color: #777; margin: 5px 0;">
                            Clique aqui ou arraste imagens (M√°x. 5 no total)
                        </p>
                    </label>
                    <input type="file" id="imagens_upload" name="imagens_upload" accept="image/*" multiple 
                           style="display: none;">
                </div>

                <!-- CAMPOS DO FORMUL√ÅRIO -->
                <label for="peca">Nome da Pe√ßa (Ex: Vestido Floral, Cal√ßa Jeans):</label>
                <input type="text" id="peca" name="peca" required>

                <label for="categoriaPeca">Tipo da Pe√ßa (Categoria):</label>
                <select id="categoriaPeca" name="categoriaPeca" required>
                    <option value="">Selecione a Categoria</option>
                    <option value="Blusa">Blusa</option>
                    <option value="Camisa">Camisa</option>
                    <option value="Cal√ßa">Cal√ßa</option>
                    <option value="Vestido">Vestido</option>
                    <option value="Saia">Saia</option>
                    <option value="Macac√£o">Macac√£o</option>
                    <option value="Shorts">Shorts</option>
                    <option value="Sapato">Sapato/Cal√ßado</option>
                    <option value="Acessorio">Acess√≥rio</option>
                    <option value="Outro">Outro</option>
                </select>

                <label for="tipo">G√™nero:</label>
                <select id="tipo" name="tipo" required>
                    <option value="Feminino">Feminino</option>
                    <option value="Masculino">Masculino</option>
                    <option value="Unissex">Unissex</option>
                </select>

                <label for="tamanho">Tamanho:</label>
                <select id="tamanho" name="tamanho" required>
                    <option value="">Selecione o Tamanho</option>
                    <!-- CORRE√á√ÉO: Valores exatos do ENUM do banco -->
                    <option value="RN">RN (Rec√©m-Nascido)</option>
                    <option value="0-3M">0-3M (0 a 3 meses)</option>
                    <option value="3-6M">3-6M (3 a 6 meses)</option>
                    <option value="6-9M">6-9M (6 a 9 meses)</option>
                    <option value="9-12M">9-12M (9 a 12 meses)</option>
                    <option value="1A">1A (1 ano)</option>
                    <option value="2A">2A (2 anos)</option>
                    <option value="3A">3A (3 anos)</option>
                    <option value="4A">4A (4 anos)</option>
                    <option value="5A">5A (5 anos)</option>
                    <option value="6A">6A (6 anos)</option>
                    <option value="7A">7A (7 anos)</option>
                    <option value="8A">8A (8 anos)</option>
                    <option value="10A">10A (10 anos)</option>
                    <option value="12A">12A (12 anos)</option>
                    <option value="14A">14A (14 anos)</option>
                    <option value="16A">16A (16 anos)</option>
                    <option value="P">P (Pequeno)</option>
                    <option value="M">M (M√©dio)</option>
                    <option value="G">G (Grande)</option>
                    <option value="GG">GG (Extra Grande)</option>
                    <option value="√önico">Tamanho √önico</option>
                </select>

                <label for="cor">Cor:</label>
                <input type="text" id="cor" name="cor">

                <label for="tecido">Tecido:</label>
                <input type="text" id="tecido" name="tecido">

                <label for="estacao">Esta√ß√£o (Ex: Ver√£o, Inverno):</label>
                <select id="estacao" name="estacao">
                    <option value="">Selecione a Esta√ß√£o</option>
                    <option value="Ver√£o">Ver√£o (Quente)</option>
                    <option value="Primavera">Primavera (Agrad√°vel)</option>
                    <option value="Outono">Outono (Frio Leve)</option>
                    <option value="Inverno">Inverno (Frio Intenso)</option>
                    <option value="Qualquer">Qualquer Esta√ß√£o</option>
                </select>

                <label for="condicao">Condi√ß√£o (Qualidade de Uso):</label>
                <select id="condicao" name="condicao" required>
                    <option value="">Selecione a Condi√ß√£o</option>
                    <!-- CORRE√á√ÉO: Valores exatos do ENUM do banco -->
                    <option value="Novo com Etiqueta">Novo com Etiqueta (Nunca usado)</option>
                    <option value="Novo sem Etiqueta">Novo sem Etiqueta (Nunca usado)</option>
                    <option value="Usado em Perfeitas Condi√ß√µes">Usado em Perfeitas Condi√ß√µes</option>
                    <option value="Usado com Pequeno Desgaste">Usado com Pequeno Desgaste</option>
                    <option value="Requer Reparo Simples">Requer Reparo Simples</option>
                    <option value="Com pouco uso">Com pouco uso</option>
                </select>

                <label for="descricao">Descri√ß√£o Detalhada:</label>
                <textarea id="descricao" name="descricao"
                    placeholder="Detalhes de uso, marca, estado de conserva√ß√£o, etc."></textarea>

                <button type="submit" id="btn-submit">Cadastrar Roupa</button>
            </form>
        </div>
    </div>
    
    <!-- MODAL DE GALERIA DE FOTOS -->
    <div id="modal-galeria-fotos" style="
        display: none; 
        position: fixed; 
        z-index: 2000; 
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.9); 
    ">
        <div class="modal-galeria-content" style="
            margin: 5% auto;
            padding: 20px;
            width: 80%;
            max-width: 900px;
            background-color: #fefefe;
            border-radius: 8px;
            position: relative;
        ">
            <span id="btn-fechar-galeria" class="close" style="top: 10px; right: 20px; position: absolute; color: #333; cursor: pointer; font-size: 30px;">&times;</span>
            <h2 id="galeria-titulo" style="margin-top: 5px;">Fotos da Pe√ßa</h2>
            
            <div id="galeria-container" style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                padding-top: 10px;
            ">
            </div>
        </div>
    </div>

    <!-- MODAL PARA DETALHES DA TROCA -->
    <div id="modal-detalhes-troca" style="
        display: none; 
        position: fixed; 
        z-index: 2000; 
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.7); 
    ">
        <div class="modal-content" style="
            margin: 5% auto;
            padding: 25px;
            width: 80%;
            max-width: 600px;
            background-color: #fefefe;
            border-radius: 8px;
            position: relative;
        ">
            <span id="btn-fechar-detalhes" class="close" style="
                position: absolute;
                top: 15px;
                right: 25px;
                color: #333;
                cursor: pointer;
                font-size: 30px;
                font-weight: bold;
            ">&times;</span>
            
            <h2>Detalhes da Troca</h2>
            <div id="conteudo-detalhes-troca">
                <!-- Conte√∫do ser√° carregado via AJAX -->
            </div>
        </div>
    </div>

    <div id="item-data-container" style="display: none;" 
         data-filtro-status="<%= typeof filtroStatus !== 'undefined' ? filtroStatus : 'Ativo' %>">
    </div>

    <script src="/js/roupas.js"></script>

    <script>
    // JavaScript para o modal de detalhes (APENAS para hist√≥rico)
    document.addEventListener('DOMContentLoaded', function() {
        const modalDetalhes = document.getElementById('modal-detalhes-troca');
        const btnFecharDetalhes = document.getElementById('btn-fechar-detalhes');
        const conteudoDetalhes = document.getElementById('conteudo-detalhes-troca');
        
        // Bot√µes "Ver Detalhes" no hist√≥rico
        document.querySelectorAll('.btn-ver-detalhes').forEach(btn => {
            btn.addEventListener('click', function() {
                const trocaId = this.getAttribute('data-troca-id');
                abrirDetalhesTroca(trocaId);
            });
        });
        
        // Fechar modal
        if (btnFecharDetalhes) {
            btnFecharDetalhes.addEventListener('click', function() {
                modalDetalhes.style.display = 'none';
            });
        }
        
        // Fechar ao clicar fora
        if (modalDetalhes) {
            modalDetalhes.addEventListener('click', function(e) {
                if (e.target === modalDetalhes) {
                    modalDetalhes.style.display = 'none';
                }
            });
        }
        
        function abrirDetalhesTroca(trocaId) {
            // Carrega os detalhes via AJAX
            fetch(`/trocas/detalhes/${trocaId}`)
                .then(response => response.text())
                .then(html => {
                    conteudoDetalhes.innerHTML = html;
                    modalDetalhes.style.display = 'block';
                })
                .catch(error => {
                    console.error('Erro ao carregar detalhes:', error);
                    conteudoDetalhes.innerHTML = '<p>Erro ao carregar detalhes da troca.</p>';
                    modalDetalhes.style.display = 'block';
                });
        }
    });
    </script>
</body>
</html>