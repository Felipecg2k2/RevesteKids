<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/feed.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <link rel="stylesheet" href="/css/item_modal_detalhes.css">
</head>
<body>
    <div class="app-layout">
        <%- include('partials/_sidebar') %>
        <div class="content-area">
            <div class="feed-content-and-filters">
                <div class="filters-column">
                    <h2>Filtros</h2>
                    <div class="filter-group">
                        <p>Gênero</p>
                        <input type="checkbox" id="feminino" name="genero" value="Feminino">
                        <label for="feminino">Feminino</label><br>
                        <input type="checkbox" id="masculino" name="genero" value="Masculino">
                        <label for="masculino">Masculino</label><br>
                        <input type="checkbox" id="unissex" name="genero" value="Unissex">
                        <label for="unissex">Unissex</label><br>
                    </div>
                    <div class="filter-group">
                        <p>Tamanho</p>
                        <div class="button-group">
                            <button class="filter-button" data-filter-type="tamanho" data-value="0-3">0-3</button>
                            <button class="filter-button" data-filter-type="tamanho" data-value="3-6">3-6</button>
                            <button class="filter-button" data-filter-type="tamanho" data-value="6+">6+</button>
                            <button class="filter-button" data-filter-type="tamanho" data-value="1-2">1-2</button>
                            <button class="filter-button" data-filter-type="tamanho" data-value="2-3">2-3</button>
                            <button class="filter-button" data-filter-type="tamanho" data-value="3-4">3-4</button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <p>Tipo de Peça</p>
                        <div class="button-group">
                            <button class="filter-button" data-filter-type="peca" data-value="Camiseta">Camiseta</button>
                            <button class="filter-button" data-filter-type="peca" data-value="Calça">Calça</button>
                            <button class="filter-button" data-filter-type="peca" data-value="Vestido">Vestido</button>
                            <button class="filter-button" data-filter-type="peca" data-value="Suéter">Suéter</button>
                            <button class="filter-button" data-filter-type="peca" data-value="Tênis">Tênis</button>
                            <button class="filter-button" data-filter-type="peca" data-value="Shorts">Shorts</button>
                        </div>
                    </div>
                </div>
                <div id="swipe-container">
                    <% if (itens.length === 0) { %>
                    <p style="width: 100%; text-align: center">
                        Parece que não há novas peças no catálogo por enquanto, volte mais tarde!
                    </p>
                    <% } else { %>
                        <% itens.forEach((item, index) => { %>
                        <div class="card-item" data-id="<%= item.id %>" data-index="<%= index %>">
                            <h2><%= item.peca %></h2>
                            <div style="height: 250px; background-color: #f0f0f0; display: flex; justify-content: center; align-items: center; border-radius: 8px;">
                                [IMAGEM AQUI - <%= item.peca %>]
                            </div>
                            <p><strong>Gênero:</strong> <%= item.tipo %></p>
                            <p><strong>Tamanho:</strong> <%= item.tamanho %></p>
                            <p><strong>Condição:</strong> <%= item.condicao %></p>
                            <div class="card-link-detalhes">
                                <button 
                                    type="button" 
                                    class="btn-ver-mais"
                                    data-item-id="<%= item.id %>"
                                    onclick="abrirModalDetalhes('<%= item.id %>')">
                                    Ver Mais Detalhes
                                </button>
                            </div>

                        </div>
                        <% }); %>
                    <% } %>
                    <div class="global-card-actions">
                        <button class="action-button btn-ignorar" id="global-btn-ignorar">
                            <span class="icon">&times;</span>
                        </button>
                        <button class="action-button btn-voltar inactive" id="global-btn-voltar">
                            <span class="icon">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 15L3 9m0 0l6-6M3 9h12a6 6 0 010 12h-3"/>
                                </svg>
                            </span>
                        </button>
                        <a href="#" class="action-button btn-trocar" id="global-btn-trocar">
                        <span class="icon">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 21L3 16.5m0 0L7.5 12M3 16.5h18M16.5 3L21 7.5m0 0L16.5 12M21 7.5H3" />
                            </svg>
                        </span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cardContainer = document.getElementById('swipe-container');
            const cards = document.querySelectorAll('.card-item');
            let currentIndex = 0;
            // Referências aos botões globais
            const globalBtnIgnorar = document.getElementById('global-btn-ignorar');
            const globalBtnVoltar = document.getElementById('global-btn-voltar');
            const globalBtnTrocar = document.getElementById('global-btn-trocar');
            
            // Adiciona a função para garantir que os botões globais sejam visíveis ou ocultos no carregamento
            function updateGlobalActionsDisplay(hasCards) {
                const globalActions = document.querySelector('.global-card-actions');
                if (globalActions) {
                    globalActions.style.display = hasCards ? 'flex' : 'none';
                }
            }

            // Função para mostrar apenas a carta atual e ajustar o botão 'Voltar'
            function updateCardDisplay() {
                cards.forEach((card, index) => {
                    card.style.display = 'none';
                    if (index === currentIndex) {
                        card.style.display = 'block';
                    }
                });
                if (globalBtnVoltar) {
                    // Garante que o botão 'Voltar' está sempre visível
                    globalBtnVoltar.style.display = 'inline-flex';
                    if (currentIndex === 0) {
                        // Desativa (coloca em 'off') na primeira peça
                        globalBtnVoltar.classList.add('inactive');
                    } else {
                        // Ativa (remove o 'off') a partir da segunda peça
                        globalBtnVoltar.classList.remove('inactive');
                    }
                }
                
                if (currentIndex >= cards.length) {
                    cardContainer.innerHTML = '<p style="width: 100%; text-align: center; padding: 50px;">Você viu todas as peças do catálogo! Volte mais tarde.</p>';
                    // Esconde os botões de ação quando não há mais cards
                    updateGlobalActionsDisplay(false); 
                } else {
                     // Garante que os botões de ação estejam visíveis quando há cards
                    updateGlobalActionsDisplay(true); 
                    // Atualiza o link do botão Trocar com o ID da peça atual
                    if (globalBtnTrocar && cards[currentIndex]) {
                        const currentItemId = cards[currentIndex].dataset.id;
                        globalBtnTrocar.href = `/trocas/propor/${currentItemId}`;
                    }
                }
            }
            
            // 1. Lógica para Avançar: Ignorar ou Trocar (avança o índice)
            function setupActionButtons() {
                // Remove listeners antigos para evitar duplicação (boa prática)
                if (globalBtnIgnorar) globalBtnIgnorar.removeEventListener('click', handleNextCard);
                if (globalBtnVoltar) globalBtnVoltar.removeEventListener('click', handlePrevCard);
                if (globalBtnTrocar) globalBtnTrocar.removeEventListener('click', handleNextCard); // Trocar também avança
                // Adiciona listeners aos botões globais
                if (globalBtnIgnorar) globalBtnIgnorar.addEventListener('click', handleNextCard);
                if (globalBtnVoltar) globalBtnVoltar.addEventListener('click', handlePrevCard);
                if (globalBtnTrocar) globalBtnTrocar.addEventListener('click', handleNextCard); // Trocar também avança
                // Seleciona todos os botões de filtro
                document.querySelectorAll('.filter-button').forEach(button => {
                    button.addEventListener('click', toggleFilter);
                });
            }
            // Handler para Avançar
            function handleNextCard(event) {
                // Impedir a navegação padrão do link 'Propor Troca' para que o JS gerencie
                if (event.currentTarget.id === 'global-btn-trocar') {
                    event.preventDefault();
                    const currentItemId = cards[currentIndex].dataset.id;
                    // Avança o índice ANTES de redirecionar para que o botão 'Voltar' funcione corretamente
                    currentIndex++; 
                    updateCardDisplay(); // Atualiza display antes de sair
                    window.location.href = `/trocas/propor/${currentItemId}`; 
                    return; // Sai da função
                }
                
                // Lógica para Ignorar (apenas avança o índice)
                if (event.currentTarget.id === 'global-btn-ignorar') {
                    // Não é necessário fazer nada aqui além de avançar o índice
                }
                
                currentIndex++;
                updateCardDisplay();
            }
            // Handler para Voltar
            function handlePrevCard(event) {
                if (currentIndex > 0) {
                    currentIndex--;
                    updateCardDisplay();
                }
            }
            //Lógica de clique para os botões de filtro (simples toggle visual)
            function toggleFilter(event) {
                const button = event.currentTarget;
                // Alterna a classe 'active' para indicar se o filtro está selecionado
                button.classList.toggle('active');
            }
            
            // Inicializa a exibição e os listeners
            if (cards.length > 0) {
                updateCardDisplay();
                setupActionButtons();
            } else {
                 // Se não houver cards, esconde os botões de ação desde o início
                updateGlobalActionsDisplay(false); 
            }
            
            // Adiciona listener para checkboxes de Gênero, apenas para fins de estado/feedback visual
            document.querySelectorAll('input[name="genero"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                });
            });
        });
    </script>
    <div id="itemDetalhesModal" class="rk-detalhes-overlay" style="display: none;">
        <div class="rk-detalhes-content">
        </div>
    </div>
    <script src="/js/item_modal.js" defer></script>
</body>
</html>